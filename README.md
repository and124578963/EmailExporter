# Python модуль выгрузки сообщений из почты в MongoDB


# 1. Описание
Python MailModule читает письма из почты, фильтрует\модифицирует\преобразует в изображение их и сохраняет в MongoDB. 
Все этапы настраиваются через конфигурационный файл.

# 2. Пререквизиты
1. Компоненты: 
   - MongoDB 6 (можно поднять через докер docker-compose.yaml) 
   - wkhtmltopdf 0.12.6 (Необходим для перевода html в картинку) https://wkhtmltopdf.org/downloads.html
   - python 3.8
   
2. Создать файл .env по образцу .env_example, где необходимо указать секреты:
   - DB_LOGIN - логин от базы данных mongodb
   - DB_PASSWRD - пароль от базы данных mongodb
   - Добавить переменные с секретами для подключения к почте, чтобы потом их использовать в настройках
   

## 3. Описание параметров MailModule 
Данные параметры задаются в ./application.yaml и отвечают за выгрузку модулем данных из почтового сервера в нашу MongoDB.
Источников почтовых сообщений может быть несколько и задаются они через профили ниже.

- **database.{db_name,host,port}** - реквизиты для подключения к MongoDB
- **attachments.path** - путь для сохранения вложений и картинок из писем
- **logging.path** - путь для логов от MailModule
- **logging.backupCount** - максимальное количество логов
- **logging.maxMegaBytes** - максимальный размер в мегабайтах одного лога 
- **logging.loggers.{name,lvl}** - название логера и его уровень
- **profiles** - массив профайлов. Каждый профайл начинается с "-" (символ элемента массива в yaml). Описывают источники email'ов.

### 3.1 Структура профилей-источников email'ов
Один профиль - это одна папка писем на конкретном почтовом сервере.
Из этой папки будут вычитываться сообщения, обрабатываться и заливаться в MongoDB.
Для начала достаточно указать только параметры из source.

  - **source** - реквизиты почты для конкретного профиля
  - **source.imap_host** - imap host почтового сервера
  - **source.login** - логин от почтового сервера, лучше использовать как переменную окружения из .env чререз !ENV ${env_name}
  - **source.password** - пароль от почтового сервера, лучше использовать как переменную окружения из .env чререз !ENV ${env_name}
  - **source.folder** - название папки, откуда будут браться письма. Без кирилицы. Общая папка называется ALL.
  - **replacements.\[{pattern,substr}\]** - список словарей, где указаны паттерны регулярных выражений и строки, на которые будет происходить
  - **image.max_width_px** - максимальная ширина конвертированного изображения из html. Большее будет обрезаться
  - **image.max_height_px** - максимальная высота изображения, если больше, то создастся следующее изображение.
  - **image.force_to_image** - true\false переводить всегда письма в картинку, даже если нет html. Некоторые письма с таблицами выгружаются чистым текстом. Данный параметр берет их версию с html разметкой.
  - **regex_last_string_mask** - регулярное выражение (python re) последней строки сообщения, после которого письмо будет обрезаться. Оставьте пустым, чтобы не использовать.
  - **filters** - параметры, которые будут исключать пришедшие письма из обработки.
  - **filters.receiver_regex_mask** - регулярное выражение (python re) получателя письма. Если не сходится, то письмо исключается.
  - **filters.restricted_subjects_regex** - список через "-" регулярных выражений (python re) запрещенных тем письма. Если сходится, то исключаем. Исключение "re:" используется, чтобы обрабатывать только первые письма в теме.
  - **extra_fields** - словарь ключ-значение, которые будут добавлены к письму при добавлении его в MongoDB.
  - **extra_fields.enable_assigne** - true/false включает или отключает возможность назначать письма на ответственную команду в чате telegram.

# 4. Запуск
 1. Перейти в папку с кодом и создать виртуальное окружение python -m venv ./venv
 2. Активировать виртуально окружение . "./venv/bin/activate"
 3. Обновить pip и установить зависимости
```
pip install --upgrade pip
pip install -r ./requirements.txt
```
 4. Настроить хотя бы 1 профиль-источник в ./application.yaml
 5. Запустить скрипт python ./main.py
 6. Выставить запуск на расписание, каждый запуск обрабатывает ранее необработанные письма. При первом запуске все сообщения в папке считаются прочитанным.




